suite: Service rendering
templates:
  - templates/service.yaml
tests:
  - it: renders a Service (decoupled from acceptClients)
    set:
      newtInstances:
        - name: main-tunnel
          enabled: true
          acceptClients: false
          auth:
            existingSecretName: newt-auth
    asserts:
      - isKind:
          of: Service
      - equal:
          path: spec.selector["newt.instance"]
          value: main-tunnel
      - equal:
          path: spec.ports[0].port
          value: 51820

  - it: defaults to LoadBalancer when service.type not set
    set:
      newtInstances:
        - name: main
          enabled: true
          auth:
            existingSecretName: newt-auth
    asserts:
      - isKind:
          of: Service
      - equal:
          path: spec.type
          value: LoadBalancer
      - equal:
          path: spec.ports[0].port
          value: 51820
      - equal:
          path: spec.ports[1].port
          value: 51821
      - notExists:
          path: spec.ports[0].nodePort
      - notExists:
          path: spec.ports[1].nodePort

  - it: renders NodePort with fixed nodePorts when specified
    set:
      newtInstances:
        - name: fixed
          enabled: true
          auth:
            existingSecretName: newt-auth
          service:
            type: NodePort
            nodePorts:
              wg: 30080
              tester: 30081
    asserts:
      - isKind:
          of: Service
      - equal:
          path: spec.type
          value: NodePort
      - equal:
          path: spec.ports[0].nodePort
          value: 30080
      - equal:
          path: spec.ports[1].nodePort
          value: 30081

  - it: renders NodePort and lets Kubernetes assign nodePorts when not set
    set:
      newtInstances:
        - name: auto
          enabled: true
          auth:
            existingSecretName: newt-auth
          service:
            type: NodePort
    asserts:
      - isKind:
          of: Service
      - equal:
          path: spec.type
          value: NodePort
      - notExists:
          path: spec.ports[0].nodePort
      - notExists:
          path: spec.ports[1].nodePort

  - it: service.enabled=false disables Service rendering
    set:
      newtInstances:
        - name: disabled
          enabled: true
          auth:
            existingSecretName: newt-auth
          service:
            enabled: false
    asserts:
      - hasDocuments:
          count: 0
